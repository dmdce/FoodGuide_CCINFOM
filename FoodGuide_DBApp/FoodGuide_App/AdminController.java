import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.ArrayList;
import javax.swing.*;

/**
 * Class: AdminController
 * This class represents the controller of the Admin window which it is in admin view.
 * It takes care the of actions when buttons are displays are pressed in the window.
 */
public class AdminController implements ActionListener {
    private AdminModel model;
    private AdminView view;
    private ArrayList<AdminView.FoodItem> cart;

    private String currentTransactionRestaurant;
    private double currentTransactionFinalPrice;

    /**
     * Constructs an AdminController with the specified model and view.
     *
     * @param m The AdminModel instance.
     * @param v The AdminView instance.
     */
    public AdminController(AdminModel m, AdminView v) {
        this.model = m;
        this.view = v;
        this.cart = new ArrayList<>();
        view.setActionListener(this);
    }

    /**
     * Handles action events triggered by user interactions in the AdminView
     * (e.g. clicking buttons)
     *
     * @param e The ActionEvent generated by a user action.
     */
    @Override
    public void actionPerformed(ActionEvent e) {
        switch (e.getActionCommand()) {
            // MANAGE DATABASE
            case "Create User":
                view.getCardLayout().show(view.getMainPanel(), "USER_CREATE");
                break;
            case "Create Transaction":
                cart.clear();
                view.getTransactionCartArea().setText("");
                view.getRestaurantComboBox().setSelectedIndex(0);
                view.getInitialPriceLabel().setText("P0.00");
                view.getPromoLabel().setText("-P0.00");
                view.getFinalPriceLabel().setText("P0.00");
                view.getCardLayout().show(view.getMainPanel(), "TRANSACTION_CREATE");
                break;
            case "ADD_ITEM":
                AdminView.FoodItem selectedItem = (AdminView.FoodItem) view.getFoodItemComboBox().getSelectedItem();
                if (selectedItem == null) return;
                cart.add(selectedItem);
                updateCartView();
                break;

            case "CALCULATE_TOTAL":
                double initialPrice = 0.0;
                for (AdminView.FoodItem item : cart) {
                    initialPrice += item.getPrice();
                }

                double promoAmount = initialPrice * 0.10; // 10% promo
                double finalPrice = initialPrice - promoAmount;

                // Update the labels in the view
                view.getInitialPriceLabel().setText(String.format("P%.2f", initialPrice));
                view.getPromoLabel().setText(String.format("-P%.2f", promoAmount));
                view.getFinalPriceLabel().setText(String.format("P%.2f", finalPrice));
                break;

            case "PROCEED_TO_RATING":
                // 1. Get and store transaction data
                currentTransactionRestaurant = (String) view.getRestaurantComboBox().getSelectedItem();
                String finalPriceText = view.getFinalPriceLabel().getText().replace("P", "");

                // 1A. Validate
                if (currentTransactionRestaurant == null || currentTransactionRestaurant.equals("[Select One]")) {
                    JOptionPane.showMessageDialog(view, "Please select a valid restaurant.", "Input Error", JOptionPane.WARNING_MESSAGE);
                    return; // Stop
                }
                if (finalPriceText.equals("0.00") || cart.isEmpty()) {
                    JOptionPane.showMessageDialog(view, "Please add items and calculate the total.", "Input Error", JOptionPane.WARNING_MESSAGE);
                    return; // Stop
                }

                currentTransactionFinalPrice = Double.parseDouble(finalPriceText);

                // 2. Reset rating form
                view.getQualityRatingComboBox().setSelectedIndex(0);
                view.getAuthenticityRatingComboBox().setSelectedIndex(0);
                view.getRatingCommentsArea().setText("");
                view.getOverallRatingLabel().setText("N/A");

                // 3. Switch panels
                view.getCardLayout().show(view.getMainPanel(), "RATING_MENU");
                break;

            // --- ADD THESE NEW CASES ---
            case "CALCULATE_RATING":
                int quality = (int) view.getQualityRatingComboBox().getSelectedItem();
                int authenticity = (int) view.getAuthenticityRatingComboBox().getSelectedItem();
                double average = (quality + authenticity) / 2.0;
                view.getOverallRatingLabel().setText(String.format("%.1f / 5.0", average));
                break;

            case "SUBMIT_RATING":
                // 1. Get all data from the form
                int finalQuality = (int) view.getQualityRatingComboBox().getSelectedItem();
                int finalAuthenticity = (int) view.getAuthenticityRatingComboBox().getSelectedItem();
                String comments = view.getRatingCommentsArea().getText();
                double finalOverall = (finalQuality + finalAuthenticity) / 2.0;

                // 2. (Backend logic placeholder) Print everything
                System.out.println("--- FINAL SUBMISSION (Transaction + Rating) ---");
                System.out.println("Restaurant: " + currentTransactionRestaurant);
                System.out.println("Final Price: P" + currentTransactionFinalPrice);
                System.out.println("Cart Items:");
                for(AdminView.FoodItem item : cart) {
                    System.out.println("  " + item.toString());
                }
                System.out.println("---------------------------------");
                System.out.println("Quality Rating: " + finalQuality);
                System.out.println("Authenticity Rating: " + finalAuthenticity);
                System.out.println("Overall Rating: " + finalOverall);
                System.out.println("Comments: " + comments);
                System.out.println("---------------------------------");

                // 3. Show success and go back to main menu
                JOptionPane.showMessageDialog(view, "Transaction and Rating Submitted! Thank you!");
                view.getCardLayout().show(view.getMainPanel(), "MAIN_MENU");
                break;

            case "GO_BACK_TO_TRANSACTION":
                view.getCardLayout().show(view.getMainPanel(), "TRANSACTION_CREATE");
                break;

            case "MANAGE DATABASE":
                view.getCardLayout().show(view.getMainPanel(), "MANAGE_DATABASE_MENU");
                break;
            case "Read User Feedback":
                System.out.println("This this supposed to be for the customer (1)");
                break;
            case "Reserve Order":
                System.out.println("Change this to make a new promo instead for admin");
                break;
            case "Log a New Dish":
                System.out.println("Log a New Dish clicked!");
                break;
            case "Personalize Meal Recommendations":
                System.out.println("This this supposed to be for the customer (2)");
                break;
            case "REGISTER_USER":
                ArrayList<String> input = view.getRegistrationInput();
                String username = input.get(0);
                String email = input.get(1);
                try {
                    // Check for empty fields first
                    if (username.isEmpty() || email.isEmpty()) {
                        JOptionPane.showMessageDialog(view,
                                "Username and Email cannot be empty.",
                                "Input Error",
                                JOptionPane.WARNING_MESSAGE);
                        return; // Stop processing
                    }

                    boolean isSuccess = model.registerNewUser(username, email);

                    if (isSuccess) {
                        // 3. Show a success message
                        JOptionPane.showMessageDialog(view,
                                "User registered successfully!",
                                "Success",
                                JOptionPane.INFORMATION_MESSAGE);

                        // 4. Go back to the manage database menu
                        view.getCardLayout().show(view.getMainPanel(), "MANAGE_DATABASE_MENU");

                    } else {
                        // 3. Show an error message (e.g., user already exists)
                        JOptionPane.showMessageDialog(view,
                                "Error: Could not register user.\nCheck console for details (e.g., duplicate entry).",
                                "Registration Failed",
                                JOptionPane.ERROR_MESSAGE);
                    }

                } catch (Exception ex) {
                    // Catch any other unexpected errors
                    ex.printStackTrace();
                    JOptionPane.showMessageDialog(view,
                            "An unexpected error occurred: " + ex.getMessage(),
                            "Error",
                            JOptionPane.ERROR_MESSAGE);
                }
                view.getCardLayout().show(view.getMainPanel(), "GENERATE_REPORTS_MENU");
                break;

            // GENERATE REPORTS
            case "GENERATE REPORTS":
                updateView();
                view.getCardLayout().show(view.getMainPanel(), "GENERATE_REPORTS_MENU");
                break;
            case "New User Registration":
                updateView();
                view.getCardLayout().show(view.getMainPanel(), "USER_REG");
                break;
            case "User Referral Impact":
                System.out.println(2);
                break;
            case "Popular Menu Items":
                System.out.println(3);
                break;
            case "Food, Ratings and Feedback":
                System.out.println(4);
                break;
            case "Revenue and Transaction":
                System.out.println(5);
                break;

            // BASIC NAVIGATION BUTTONS
            case "GO BACK", "GO BACK GENERATE REPORTS":
                view.getCardLayout().show(view.getMainPanel(), "MAIN_MENU");
                break;
            case "GO BACK USER REG":
                view.getCardLayout().show(view.getMainPanel(), "GENERATE_REPORTS_MENU");
                break;
            case "GO BACK TO MAIN":
                view.dispose();
                model.getMenuController().showMenuView();
                break;
        }
    }

    /**
     * Refreshes all panels, re-attaches listeners, and updates displayed data.
     * Called after any update to the model or view state to ensure UI consistency.
     */
    private void updateView() {
        view.refreshPanels();
        view.setActionListener(this);
    }
    private void updateCartView() {
        JTextArea cartArea = view.getTransactionCartArea();
        cartArea.setText(""); // Clear it first

        if (cart.isEmpty()) {
            cartArea.setText("Cart is empty.");
        } else {
            for (AdminView.FoodItem item : cart) {
                cartArea.append(item.toString() + "\n");
            }
        }
    }
}